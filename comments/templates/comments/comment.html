{#title=comment.title#}
{#user_id = comment.user_id#}
{#claim_id =comment.claim_id #}
{#title =comment.title #}
{#description = comment.description #}
{#url = comment.url #}
{#verdict_date =comment.verdict_date #}
{#tags = comment.tags #}
{#label = comment.label #}
{#pos_votes = comment.pos_votes #}
{#neg_votes = comment.neg_votes#}
{%  load mathfilters %}
<div style="margin: auto;">

    <div class="claim_box" style="padding: 20px; width: 100%;">
        <p id="{{ comment.id }}_error_msg" style="color: red; font-size: 12px;" hidden>**Error Message: </p>
        <table id="comment_{{ comment.id }}" style="width: 100%;">
            <tr>
                <td class="left" style="width: 100%;">
                    <h4 id="comment_{{ comment.id }}_title"><b>{{ comment.title }}</b></h4>
                    <input hidden="hidden" id="{{ comment.id }}_title" value="{{ comment.title }}" type="text" placeholder="{{ comment.title }}" style="width: 90%; margin: 10px;">
                </td>
                <td class="right">User: <a href="#">{{ user.username }}</a></td>
            </tr>
            <tr>
                <td class="left">
                    <p id="comment_{{ comment.id }}_description">{{ comment.description }}</p>
                    <textarea hidden="hidden" id="{{ comment.id }}_description" placeholder="{{ comment.description }}" style="width: 90%; margin: 10px;"></textarea><br>
                </td>
                <td class="right"><p>
                    <img src="{{ user.user_img }}" style="max-height: 90px; max-width: 90px;"><br>
                    {% load static %}
                    {%  if comment.system_label %}
                        <img style="max-width: 70px;" src="{% static 'claims/assets/images/TrueLabel.png' %}" >
                        <input type="radio" id='comment_{{ comment.id }}_true_radio' name="label" hidden='hidden' value="{{True}}" checked><span id='comment_{{ comment.id }}_true_label' hidden>True</span><br>
                        <input type="radio" id='comment_{{ comment.id }}_false_radio' name="label" hidden='hidden' value="{{False}}"><span id='comment_{{ comment.id }}_false_label' hidden>False</span>
                    {% else %}
                        <img style="max-width: 70px; " src="{% static 'claims/assets/images/FalseLabel.png' %}" >
                        <input type="radio" id='comment_{{ comment.id }}_true_radio' name="label" hidden='hidden' value="{{True}}"><span id='comment_{{ comment.id }}_true_label' hidden>True</span><br>
                        <input type="radio" id='comment_{{ comment.id }}_false_radio' name="label" hidden='hidden' value="{{False}}" checked><span id='comment_{{ comment.id }}_false_label' hidden>False</span>
                    {%  endif %}

                </p></td>
            </tr>
            <tr>
                <td class="left">
                    References:
                    <a id="comment_{{ comment.id }}_reference" href={{ comment.url }}>website</a>
                    <input hidden="hidden" id="{{ comment.id }}_reference" value="{{ comment.url }}" type="text" placeholder="{{ comment.url }}" style="width: 90%; margin: 10px;">
                </td>
                <td class="right" style="text-align: center;">
                    <div style="margin: auto;">
                        {% if request.user.is_authenticated %}
                            <button id="{{ comment.id }}_arrow_up" type="submit" class="arrow_up" style="">▲</button>
                        {% endif %}
                        <br>
                        <span id="{{ comment.id }}_voteCount" style="text-align: center; color: #000;">{{ comment.up_votes.count|sub:comment.down_votes.count }}</span>
                        <br>
                        {% if request.user.is_authenticated %}
                            <button id="{{ comment.id }}_arrow_down" type="submit" class="arrow_down">▼</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            <tr>
                <td class="left">
                {% if request.user.is_authenticated and comment.user_id == request.user.id %}
                    <button id="{{ comment.id }}_edit" type="submit" class="edit_comment" onclick="edit_comment()" style="margin: 10px 0;">Edit your comment</button>
                    <button id="{{ comment.id }}_delete" type="submit" class="delete_comment" style="margin: 10px 0;">Delete</button>
                    <button id="{{ comment.id }}_save" type="submit" hidden='hidden' class="btn btn-save" style="margin: 10px 0;">Save</button>
                {% endif %}
                </td>
                <td class="right"></td>
            </tr>
        </table>
    </div>
</div>
{#<meta name="csrf-token" content="{{ csrf_token }}">#}
<script>
    let up_voted_{{ comment.id }} = false;
    let down_voted_{{ comment.id }} = false;
    let up_count_{{ comment.id }} = {{ comment.up_votes.count }};
    let down_count_{{ comment.id }} = {{ comment.down_votes.count }};

    $(document).ready(function () {
        {% for voted_user in comment.up_votes.all %}
            {% if request.user.id == voted_user.id %}
                up_voted_{{ comment.id }} = true;
                document.getElementById("{{ comment.id }}_arrow_up").style.color = "#555";
            {% endif %}
        {% endfor %}
        {% for voted_user in comment.down_votes.all %}
            {% if request.user.id == voted_user.id %}
                down_voted_{{ comment.id }} = true;
                document.getElementById("{{ comment.id }}_arrow_down").style.color = "#555";
            {% endif %}
        {% endfor %}
    });

    $("#{{ comment.id }}_arrow_up").click(function(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: "{% url 'comments:up_vote' %}",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            data: {
                comment_id: '{{ comment.id }}',
                user_id: '{{ request.user.id }}'
            },
            success: function () {
                if(!up_voted_{{ comment.id }}) {
                    up_voted_{{ comment.id }} = true;
                    up_count_{{ comment.id }}++;
                    document.getElementById("{{ comment.id }}_arrow_up").style.color = "#555";
                    if(down_voted_{{ comment.id }}) {
                        down_count_{{ comment.id }}--;
                        down_voted_{{ comment.id }} = false;
                        document.getElementById("{{ comment.id }}_arrow_down").style.color = "#C0C0C0";
                    }
                }
                else{
                    up_voted_{{ comment.id }} = false;
                    up_count_{{ comment.id }}--;
                    document.getElementById("{{ comment.id }}_arrow_up").style.color = "#C0C0C0";
                }
                $("#{{ comment.id }}_voteCount").text(up_count_{{ comment.id }}-down_count_{{ comment.id }});
            },
            error: function (error) {
                console.log(error);
            }
        });
    });
    $("#{{ comment.id }}_arrow_down").click(function(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: "{% url 'comments:down_vote' %}",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            data: {
                comment_id: '{{ comment.id }}',
                user_id: '{{ request.user.id }}'
            },
            success: function () {
                if(!down_voted_{{ comment.id }}) {
                    down_voted_{{ comment.id }} = true;
                    down_count_{{ comment.id }}++;
                    document.getElementById("{{ comment.id }}_arrow_down").style.color = "#555";
                    if(up_voted_{{ comment.id }}) {
                        up_count_{{ comment.id }}--;
                        up_voted_{{ comment.id }} = false;
                        document.getElementById("{{ comment.id }}_arrow_up").style.color = "#C0C0C0";
                    }
                }
                else{
                    down_voted_{{ comment.id }} = false;
                    down_count_{{ comment.id }}--;
                    document.getElementById("{{ comment.id }}_arrow_down").style.color = "#C0C0C0";
                }
                $("#{{ comment.id }}_voteCount").text(up_count_{{ comment.id }}-down_count_{{ comment.id }});
            },
            error: function (error) {
                console.log(error);
            }
        });
    });

    function edit_comment() {
        $("#comment_{{ comment.id }}_title").attr("hidden", true);
        $("#comment_{{ comment.id }}_description").attr("hidden", true);
        $("#comment_{{ comment.id }}_reference").attr("hidden", true);

        $("#{{ comment.id }}_title").attr("hidden", false);
        $("#{{ comment.id }}_description").attr("hidden", false);
        $("#{{ comment.id }}_reference").attr("hidden", false);

        $("#comment_{{ comment.id }}_true_radio").attr("hidden", false);
        $("#comment_{{ comment.id }}_false_radio").attr("hidden", false);
        $("#comment_{{ comment.id }}_true_label").attr("hidden", false);
        $("#comment_{{ comment.id }}_false_label").attr("hidden", false);
        $("#{{ comment.id }}_save").attr("hidden", false);
    }

    $("#{{ comment.id }}_save").click(function(e){
        {#e.preventDefault();#}
        $.ajax({
            type: 'POST',
            url: "{% url 'comments:edit_comment' %}",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            data: {
                comment_id: '{{ comment.id }}',
                comment_title: $("#{{ comment.id }}_title").val(),
                comment_description: $("#{{ comment.id }}_description").val(),
                comment_reference: $("#{{ comment.id }}_reference").val(),
                comment_label: document.querySelector('input[name="label"]:checked').value,
                user_id: '{{ request.user.id }}',
            },
            success: function () {
                location.href = "http://127.0.0.1:8000/claim/{{ comment.claim_id }}"
            },
            error: function (error) {
                console.log(error);
                var err = error.responseText;
                $("#{{ comment.id }}_error_msg").attr("hidden", false);
                console.log(err.title);
                {#console.log(err.text);#}
                {#console.log(JSON.parse(error.responseText));#}
                location.href = "http://127.0.0.1:8000/claim/{{ comment.claim_id }}"

            }
        });
    });

    $("#{{ comment.id }}_delete").click(function(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: "{% url 'comments:delete_comment' %}",
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            data: {
                comment_id: '{{ comment.id }}',
                user_id: '{{ request.user.id }}'
            },
            success: function (page) {
                location.href = "http://127.0.0.1:8000/claim/{{ comment.claim_id }}"
            },
            error: function (error) {
                console.log(error);
            }
        });
    });

    function getCookie(c_name)
    {
        if (document.cookie.length > 0)
        {
            c_start = document.cookie.indexOf(c_name + "=");
            if (c_start != -1)
            {
                c_start = c_start + c_name.length + 1;
                c_end = document.cookie.indexOf(";", c_start);
                if (c_end == -1) c_end = document.cookie.length;
                return unescape(document.cookie.substring(c_start,c_end));
            }
        }
        return "";
    }


</script>