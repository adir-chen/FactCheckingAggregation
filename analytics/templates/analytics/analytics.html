{% extends 'claims/layout.html' %}

{% block page_content %}
    <!--Table and divs that hold the pie charts-->
    <div id="analytics_page" class="page_wrapper">
        <h4>WTFact Analytics:</h4>
        <div>
            <table class="columns">
                <tr>
                    <td>
                        <div style="border: 2px solid lightblue; padding: 20px; border-radius: 7px; margin: 10px;">
                            <div id="chart_months" class="chart_div"></div>
                            <h6>Change months:</h6>
                            <div>
                                from <input type="month" id="custom_start_date" value="2019-01">
                                to <input type="month" id="custom_end_date" value="{{ current_date }}">
                                <button id="custom_button" class="btn btn-info">Set</button>
                                <button id="reset_button" class="btn btn-danger" style="float: right">Reset</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="border: 2px solid lightblue; padding: 20px; border-radius: 7px; margin: 10px;">
                            <div id="chart_days" class="chart_div"></div>
                            <h6>Change Month:</h6>
                            <div>
                                <input type="month" id="custom_start_date2" value="2019-01">
                                <button id="custom_button2" class="btn btn-info">Set</button>
                                <button id="reset_button2" class="btn btn-danger" style="float: right">Reset</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="border: 2px solid lightblue; padding: 20px; border-radius: 7px; margin: 10px;">
                            <h5>Show top viewed claims:</h5>
                            Number of claims: <input id="num_of_claims" type="number" min="1" max="10" value="5"><br><br>
                            from <input type="date" id="claims_start_date" value="2019-01-01" max="{% now "Y-m-d" %}">
                            to <input type="date" id="claims_end_date" value="{% now "Y-m-d" %}" max="{% now "Y-m-d" %}">
                            <br><br>
                            <button id="top_claims" class="btn btn-info">click</button>
                            <div >
                                <table id="Top Claims">
                                    <tr>
                                        <td>
                                            <div>

                                            </div>
                                        </td>
                                    </tr>
                                </table>
                                {#                            <button id="topClaims" >click</button>#}
                            </div>
                        </div>

                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', {packages: ['corechart', 'bar']});
        let reports_months = {{ reports_months }};
        let reports_days = {{ reports_days }};
        google.charts.setOnLoadCallback(function () {
            draw_chart_by_months(reports_months);
            draw_chart_by_days(reports_days);
        });

        function get_monthly_views(reports){
            {# reports is an array of type int(year), int(month), int(views)#}
            let rows = [['Month', 'Views']];
            for(let i = 0; i < reports.length; i++){
                let row = reports[i];
                rows.push(['' + row[1] + '/' + row[0] % 1000, row[2]]);
            }
            return rows;
        }

        function get_daily_views(reports){
            let rows = [['Days', 'Views']];
            for(let i = 0; i < reports.length; i++){
                let row = reports[i];
                rows.push([row[2], row[3]]);
            }
            return rows;
        }

        function draw_chart_by_months(reports){
            let data = new google.visualization.arrayToDataTable(get_monthly_views(reports));
            let options = {
                chart: {
                    title: 'Title',
                    subtitle: 'Subtitle'
                },
                title: "Views by months",
                hAxis: {
                    title: 'Months'
                },
                vAxis: {
                    title: 'Views'
                }
            };
            let materialChart =  new google.visualization.ColumnChart(document.getElementById('chart_months'));
            materialChart.draw(data, options);
        }

        function draw_chart_by_days(reports){
            let data = new google.visualization.arrayToDataTable(get_daily_views(reports));
            let options = {
                chart: {
                    title: 'Title',
                    subtitle: 'Subtitle'
                },
                title: "Views by days in month",
                hAxis: {
                    title: 'Day Of Week'
                },
                vAxis: {
                    title: 'Views'
                }

            };
            let materialChart = new google.visualization.ColumnChart(document.getElementById('chart_days'));
            materialChart.draw(data, options);
        }

        $("#custom_button").click(function(e){
            e.preventDefault();
            let start_date = $("#custom_start_date").val() + '-01';
            let end_date = $("#custom_end_date").val();
            end_date = end_date + '-' + new Date(end_date.substring(0,4), end_date.substring(5,8), 0).getDate();
            $.ajax({
                type: 'POST',
                url: "{% url 'analytics:view_customized_analytics' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    start_date: start_date,
                    end_date: end_date,
                    dimensions: 'ga:year, ga:month'
                },
                success: function (response) {
                    draw_chart_by_months(response[0]);
                },
                error: function (error) {

                }
            });
        });

        $("#custom_button2").click(function(e){
            e.preventDefault();
            let start_date = $("#custom_start_date2").val() + '-01';
            let end_date = $("#custom_start_date2").val();
            end_date = end_date + '-' + new Date(end_date.substring(0, 4), end_date.substring(5,8), 0).getDate();
            $.ajax({
                type: 'POST',
                url: "{% url 'analytics:view_customized_analytics' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    start_date: start_date,
                    end_date: end_date,
                    dimensions: 'ga:year, ga:month, ga:day',
                },
                success: function (response) {
                    draw_chart_by_days(response[0]);
                },
                error: function (error) {

                }
            });
        });

        $("#reset_button").click(function (e) {
            draw_chart_by_months({{ x }});
        });

        $("#reset_button2").click(function (e) {
            draw_chart_by_days({{ y }});
        });

        $("#top_claims").click(function(e){
            $.ajax({
                type: 'POST',
                url: "{% url 'analytics:view_top_n_claims' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    start_date: $("#claims_start_date").val(),
                    end_date: $("#claims_end_date").val(),
                    n: $("#num_of_claims").val()
                },
                success: function (response) {
                    let response_table = response['reports'];
                    for(let i=0; i<response_table.length; i++) {
                        var data = response_table[i];
                        var table = document.getElementById("Top Claims");
                        var row = table.insertRow();
                        var cell = row.insertCell();
                        cell.innerText = '['+(i+1)+'] '+ data['claim']['claim'];
                    }

                },
                error: function (error) {

                }
            });
        });

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) c_end = document.cookie.length;
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
    </script>
{% endblock %}

{% block claim_head_title %}
    FactCheckProject | Analytics
{% endblock %}