{% extends 'claims/layout.html' %}

{% block page_content %}
    <!--Table and divs that hold the pie charts-->
    <div id="analytics_page" class="page_wrapper">
        <h4>WTFact Analytics:</h4>
        <div>
            <table class="columns">
                <tr>
                    <td>
                        <div style="border: 2px solid lightblue; padding: 10px">
                            <div id="chart_div" class="chart_div"></div>
                            <h6>Change months:</h6>
                            <div>
                                from <input type="month" id="custom_start_date" value="2019-01">
                                to <input type="month" id="custom_end_date" value="{{ current_date }}">
                                <button id="custom_button">Set</button>
                                <button id="reset_button" style="float: right">Reset</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="border: 2px solid lightblue; padding: 10px">
                            <div id="chart_div1" class="chart_div"></div>
                            <h6>Change Month:</h6>
                            <div>
                                <input type="month" id="custom_start_date2" value="2019-01">
                                <button id="custom_button2">Set</button>
                                <button id="reset_button2" style="float: right">Reset</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div style="border: 2px solid lightblue; padding: 10px">
                            <table id="Top Claims">
                                <tr>
                                    <td>
                                        <div>

                                        </div>
                                    </td>
                                </tr>
                            </table>
{#                            <button id="topClaims" >click</button>#}
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
        google.charts.load('current', {packages: ['corechart', 'bar']});
        var loaded_reports1 = {{ reports_monthly }};
        var loaded_reports2 = {{ reports_days }};
        google.charts.setOnLoadCallback(function () {
            draw_chart_by_months({{ reports_months }});
            draw_chart_by_days({{ reports_days }});
        });

        function get_monthly_views(reports){
            {# reports is an array of type int(year), int(month), int(views)#}
            let rows = [['Month', 'Views']];
            for(let i = 0; i < reports.length; i++){
                let row = reports[i];
                rows.push(['' + row[1] + '/' + row[0] % 1000, row[2]]);
            }
            return rows;
        }

        function get_daily_views(reports){
            let rows = [['Days', 'Views']];
            for(let i = 0; i < reports.length; i++){
                let row = reports[i];
                rows.push([row[2], row[3]]);
            }
            return rows;
        }

        function draw_chart_by_months(reports){
            let data = new google.visualization.arrayToDataTable(get_monthly_views(reports));
            let options = {
                chart: {
                    title: 'Title',
                    subtitle: 'Subtitle'
                },
                title: "Views by months",
                hAxis: {
                    title: 'Months'
                },
                vAxis: {
                    title: 'Views'
                }
            };
            let materialChart =  new google.visualization.ColumnChart(document.getElementById('chart_months'));
            materialChart.draw(data, options);
        }

        function draw_chart_by_days(reports){
            let data = new google.visualization.arrayToDataTable(get_daily_views(reports));
            let options = {
                chart: {
                    title: 'Title',
                    subtitle: 'Subtitle'
                },
                title: "Views by days in month",
                hAxis: {
                    title: 'Day Of Week'
                },
                vAxis: {
                    title: 'Views'
                }

            };
            let materialChart = new google.visualization.ColumnChart(document.getElementById('chart_days'));
            materialChart.draw(data, options);
        }

        $("#custom_button").click(function(e){
            e.preventDefault();
            let start_date = $("#custom_start_date").val() + '-01';
            let end_date = $("#custom_end_date").val();
            end_date = end_date + '-' + new Date(end_date.substring(0,4), end_date.substring(5,8), 0).getDate();
            $.ajax({
                type: 'POST',
                url: "{% url 'analytics:view_customized_analytics' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    start_date: start_date,
                    end_date: end_date,
                    dimensions: 'ga:year, ga:month'
                },
                success: function (response) {
                    draw_chart_by_months(response[0]);
                },
                error: function (error) {

                }
            });
        });

        $("#custom_button2").click(function(e){
            e.preventDefault();
            let start_date = $("#custom_start_date2").val() + '-01';
            let end_date = $("#custom_start_date2").val();
            end_date = end_date + '-' + new Date(end_date.substring(0, 4), end_date.substring(5,8), 0).getDate();
            $.ajax({
                type: 'POST',
                url: "{% url 'analytics:view_customized_analytics' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    dimensions: 'ga:year, ga:month, ga:day',
                    start_date: start_date,
                    end_date: end_date
                },
                success: function (response) {
                    draw_chart_by_days(response[0]);
                },
                error: function (error) {

                }
            });
        });

        $("#reset_button").click(function (e) {
            draw_chart_by_months(loaded_reports1);
        });

        $("#reset_button2").click(function (e) {
            draw_chart_by_days(loaded_reports2);
        });

        $.ajax({
            type: 'POST',
            url: "{% url 'analytics:view_N_top_claims' %}",
            headers: { "X-CSRFToken": getCookie('csrftoken') },
            data: {
                start_date: '2018-01-01',
                end_date: 'today',
                n: 5
            },
            success: function (response) {
                {#"Top Claims"#}
                console.log("started entering response to table");
                console.log(response);

                for(i=0; i<response.length; i++) {

                    console.log(i);
                    var data = response[i];
                    var table = document.getElementById("Top Claims");
                    var row = table.insertRow();
                    var cell = row.insertCell();
                    cell.innerText = '['+i+'] S'+ data['claim']['claim'];
                }

            },
            error: function (error) {

            }
        });

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) c_end = document.cookie.length;
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
    </script>
{% endblock %}

{% block claim_head_title %}
    FactCheckProject | Analytics
{% endblock %}