{% extends 'claims/layout.html' %}
{% load social_widgets %}
{% block page_content %}
    <div id="claim_page">
        <p id="claim_{{ claim.id }}_error_msg" style="color: red; font-size: 12px;" hidden></p>
        <h1 id="claim_page_title" style="margin-bottom: 30px;">{{ claim.claim }}</h1>
        <div id="claim_page_title_wrapper" style="display: inline-block; border-radius: 10px; background: #aabfd6; padding: 20px; margin-bottom: 20px; width: 100%;">
            <img id="img_src_{{ claim.id }}" src="{{ claim.image_src }}" style="float: left; max-width: 650px; width: 100%; border-radius: 10px;">
            <div style="min-height: 365px; float: right; padding: 20px; width: 260px; border: 1px solid #b4b4b4; background: #fff; border-radius: 10px; margin-left: 20px;">
                {% if claim.authenticity_grade >= 50 %}
                    <div style="background: #d4edda; width: 220px; color: #155724; text-align: center; border-radius: 10px; border: 1px solid #c3e6cb; padding: 20px; margin-bottom: 20px;">
                {% else %}
                    <div style="background: #d35b66; width: 220px; color: #721e3a; text-align: center; border-radius: 10px; border: 1px solid #721e3a; padding: 20px; margin-bottom: 20px;">
                {% endif %}
                        <span style="font-size: 20px;">Authenticity Grade:</span><br>
                        <span style="font-size: 72px; font-weight: bold;">{{ claim.authenticity_grade }}%</span><br>
                        <span style="font-size: 20px;">(correct)</span></div>
                        <h5>Category: {{ claim.category }}</h5>
                    </div>
            </div>

        <div id="claim_edit" hidden="hidden">
            Claim: <input id="{{ claim.id }}_claim" value="{{ claim.claim }}" type="text" placeholder="{{ claim.claim }}" style="width: 100%; margin: 10px;"><br>
            Category: <input id="{{ claim.id }}_category" value="{{ claim.category }}" type="text" placeholder="{{ claim.category }}" style="width: 100%; margin: 10px;"><br>
            Tags: <input id="{{ claim.id }}_tags" value="{{ claim.tags }}" type="text" placeholder="{{ claim.tags }}" style="width: 100%; margin: 10px;"><br>
            Image Url: <input id="{{ claim.id }}_image_src" value="{{ claim.image_src }}" type="text" placeholder="{{ claim.image_src }}" style="width: 100%; margin: 10px;">
        </div>

        <br>
        {% if request.user.is_authenticated %}
            {% if claim.user_id == request.user.id %}
                <button id="{{ claim.id }}_claim_edit" hidden="hidden" type="submit" class="btn btn-info" onclick="edit_claim()" style="margin: 10px 0;">Edit your claim</button>
                <button id="{{ claim.id }}_claim_save" hidden="hidden" type="submit" class="btn btn-info" style="margin: 10px 0;">Save</button>
                <button id="{{ claim.id }}_claim_delete" type="submit" class="btn btn-danger" style="margin: 10px 0;">Delete</button>
            {% endif %}
            <button id="{{ claim.id }}_claim_report_spam" type="submit" class="btn btn-danger" style="margin: 10px 0;">Report Spam</button>
        {% endif %}
        {% load static %}
        <a class="btn twitter-share-button" href="https://twitter.com/intent/tweet?text=http://{{ request.META.HTTP_HOST }}{{ request.path }}%20"
          data-size="large"><img src="{% static 'claims/assets/images/twitter_icon.png' %}"> Share claim on Twitter</a>
        <hr><br>
        <div id="comments">
        {% if comments %}
            <h3>Users' verdicts:</h3>
            <br>
            {% for comment, user_details  in comments.items %}
                {% include 'comments/comment.html' with comment=comment user_details=user_details request=request only %}
            {% endfor %}
        {% else %}
            <h3>No verdicts yet.</h3>
        {%  endif %}
        </div>
        {% if request.user.is_authenticated %}
        <br><hr>
        <h3>Add Comment:</h3>
        <br>
        <div class="new_comment claim_box" style="width: 100%; padding: 20px 40px 20px 20px;">
            <p id="{{ claim.id }}_new_comment_error_msg" style="color: red; font-size: 12px;" hidden></p>
            <input id="{{ claim.id }}_new_comment_title" name="title" value="{{ title }}" type="text" placeholder="Title" style="width: 100%; margin: 10px;"><br>
            <textarea id="{{ claim.id }}_new_comment_description" name="description" placeholder="Description" style="width: 100%; margin: 10px;"></textarea><br>
            <input name="claim_id" value="{{ claim.id }}" type="hidden">
            <input id="{{ claim.id }}_new_comment_tags" type="text" placeholder="Tags (separated by space). Used for searching purpose." style="width: 100%; margin: 10px;"><br>
            <p style="width: 100%; margin: 10px;">Verdict Date (according to source website):</p>
            <input type="date" id="{{ claim.id }}_new_comment_date" value="{% now "Y-m-d" %}" max="{% now "Y-m-d" %}" style="width: 100%; margin: 10px;">
            <input id="{{ claim.id }}_new_comment_url" name="url" value="{{ url }}" type="text" placeholder="Website url" style="width: 100%; margin: 10px;"><br>
            <div style="margin: 10px;">
                <input id="{{ claim.id }}_new_comment_true_label" type="radio" name="label" value="True">True<br>
                <input id="{{ claim.id }}_new_comment_false_label" type="radio" name="label" value="False">False<br>
                <input id="{{ claim.id }}_new_comment_unknown_label" type="radio" name="label" value="Unknown" checked>Unknown<br>
            </div>
            <p id="add_new_comment" style="color: dodgerblue; font-size: 12px;" >If you want to edit your comment you will be able to do so during the next 5 minutes from the time you added it.</p>
            <button type="submit" id="{{ claim.id }}_new_comment_save" class="btn btn-info" style="margin: 10px 0;">Add your comment</button>
        </div>
        {% endif %}
        </div>
    </div>
    <script>
        let claim_timestamp = new Date('{{ claim.timestamp|date:"D, d M Y H:i:s" }}');
        if (((new Date() - claim_timestamp) / 60000) <= 5){
            $("#{{ claim.id }}_claim_edit").attr("hidden", false);
        }
        function edit_claim() {
            $("#claim_page_title_wrapper").attr("hidden", true);
            $("#claim_edit").attr("hidden", false);
            $("#{{ claim.id }}_claim_save").attr("hidden", false);
            $("#{{ claim.id }}_claim_edit").attr("hidden", true);
        }

        $("#{{ claim.id }}_new_comment_save").click(function(){
            $.ajax({
                type: 'POST',
                url: "{% url 'comments:add_comment' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    claim_id: '{{ claim.id }}',
                    title: $("#{{ claim.id }}_new_comment_title").val(),
                    description: $("#{{ claim.id }}_new_comment_description").val(),
                    url: $("#{{ claim.id }}_new_comment_url").val(),
                    tags: $("#{{ claim.id }}_new_comment_tags").val(),
                    verdict_date: $("#{{ claim.id }}_new_comment_date").val(),
                    label: document.querySelector('input[name="label"]:checked').value,
                },
                success: function () {
                    location.href = 'http://{{ request.META.HTTP_HOST }}/claim/{{ claim.id }}';
                },
                error: function (error) {
                    let err = error.responseText.split('\n')[1];
                    document.getElementById("{{ claim.id }}_new_comment_error_msg").innerHTML =
                    'Error: <br>' + err;
                     $("#{{ claim.id }}_new_comment_error_msg").attr("hidden", false);
                }
            });
        });

        $("#{{ claim.id }}_claim_save").click(function(){
            $.ajax({
                type: 'POST',
                url: "{% url 'claims:edit_claim' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    claim_id: '{{ claim.id }}',
                    claim: $("#{{ claim.id }}_claim").val(),
                    category: $("#{{ claim.id }}_category").val(),
                    tags: $("#{{ claim.id }}_tags").val(),
                    image_src: $("#{{ claim.id }}_image_src").val(),
                },
                success: function () {
                    location.href = 'http://{{ request.META.HTTP_HOST }}/claim/{{ claim.id }}';
                },
                error: function (error) {
                    let err = error.responseText.split('\n')[1];
                    document.getElementById("claim_{{ claim.id }}_error_msg").innerHTML =
                    'Error: <br>' + err;
                     $("#claim_{{ claim.id }}_error_msg").attr("hidden", false);
                }
            });
        });

        $("#{{ claim.id }}_claim_delete").click(function(e){
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: "{% url 'claims:delete_claim' %}",
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                data: {
                    claim_id: '{{ claim.id }}',
                },
                success: function () {
                    location.href = 'http://{{ request.META.HTTP_HOST }}';
                },
                error: function (error) {
                    let err = error.responseText.split('\n')[1];
                    document.getElementById("#claim_{{ claim.id }}_error_msg").innerHTML =
                    'Error: <br>' + err;
                    $("#claim_{{ claim.id }}_error_msg").attr("hidden", false);
                }
            });
        });

        $("#{{ claim.id }}_claim_report_spam").click(function(e){
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: "{% url 'claims:report_spam' %}",
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                data: {
                    claim_id: '{{ claim.id }}',
                },
                success: function () {
                    location.href = 'http://{{ request.META.HTTP_HOST }}/claim/{{ claim.id }}';
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });

        function getCookie(c_name) {
            if (document.cookie.length > 0) {
                c_start = document.cookie.indexOf(c_name + "=");
                if (c_start != -1) {
                    c_start = c_start + c_name.length + 1;
                    c_end = document.cookie.indexOf(";", c_start);
                    if (c_end == -1) c_end = document.cookie.length;
                    return unescape(document.cookie.substring(c_start, c_end));
                }
            }
            return "";
        }
    </script>
{% endblock %}

{% block claim_head_title %}
    FactCheckProject | {{ claim }}
{% endblock %}