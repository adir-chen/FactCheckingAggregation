{% extends 'claims/layout2.html' %}

{% block page_content %}
    <div id="claim_page">
        <div  id="claim_page_title_wrapper">
            <h1 id="claim_page_title">{{ claim.claim }}</h1>
            <p>Authenticity Grade: {{ claim.authenticity_grade }}% (correct)</p>
            <img id="img_src_{{ claim.id }}" src="{{ claim.image_src }}">
            <input hidden="hidden" id="{{ claim.id }}_image_src" value="{{ claim.image_src }}" type="text" placeholder="{{ claim.image_src }}">
        </div>
        <div id="claim_edit" hidden="hidden">
            Claim: <input id="{{ claim.id }}_claim" value="{{ claim.claim }}" type="text" placeholder="{{ claim.claim }}" style="width: 100%; margin: 10px;"><br>
            Category: <input id="{{ claim.id }}_category" value="{{ claim.category }}" type="text" placeholder="{{ claim.category }}" style="width: 100%; margin: 10px;"><br>
            Image Url: <input id="{{ claim.id }}_tags" value="{{ claim.tags }}" type="text" placeholder="{{ claim.tags }}" style="width: 100%; margin: 10px;">
        </div>
        {% if request.user.is_authenticated and claim.user_id == request.user.id %}
            <button id="{{ claim.id }}_claim_edit" type="submit" class="btn btn-info" onclick="edit_claim()" style="margin: 10px 0;">Edit your claim</button>
            <button id="{{ claim.id }}_claim_delete" type="submit" class="btn btn-info" style="margin: 10px 0;">Delete</button>
            <button id="{{ claim.id }}_claim_save" hidden="hidden" type="submit" class="btn btn-info" style="margin: 10px 0;">Save</button>
        {% endif %}
        <hr><br>

        <div id="comments">
            {% if comments %}
                <h3>Users' verdicts:</h3>
                <br>
                {% for comment, user  in comments.items %}
                    {% include 'comments/comment.html' with comment=comment user=user request=request only %}
                {% endfor %}
            {% else %}
                <h3>No verdicts yet.</h3>
            {%  endif %}
        </div>
        {% if request.user.is_authenticated %}
        <br><hr>
        <h3>Add Comment:</h3>
        <br>
        <div class="new_comment claim_box" style="width: 100%; padding: 20px 40px 20px 20px;">
            <input id="{{ claim.id }}_new_comment_title" name="title" value="{{ title }}" type="text" placeholder="Title" style="width: 100%; margin: 10px;"><br>
            <textarea id="{{ claim.id }}_new_comment_description" name="description" placeholder="Description" style="width: 100%; margin: 10px;"></textarea><br>
            <input name="claim_id" value="{{ claim.id }}" type="hidden">
            <input name="user_id" value="{{ request.user.id }}" type="hidden">
            <input id="{{ claim.id }}_new_comment_url" name="url" value="{{ url }}" type="text" placeholder="Website url" style="width: 100%; margin: 10px;"><br>
            <div style="margin: 10px;">
                <input id="{{ claim.id }}_new_comment_true_label" type="radio" name="label" value="{{True}}">True<br>
                <input id="{{ claim.id }}_new_comment_false_label" type="radio" name="label" value="{{False}}">False<br>
            </div>
            <button type="submit" id="{{ claim.id }}_new_comment_save" class="btn btn-info" style="margin: 10px 0;">Add your comment</button>
        </div>
        {% endif %}
    </div>

    <script>
        function edit_claim() {
            $("#claim_page_title_wrapper").attr("hidden", true);
            $("#claim_edit").attr("hidden", false);
            $("#{{ claim.id }}_claim_save").attr("hidden", false);
            $("#{{ claim.id }}_claim_edit").attr("hidden", true);
        }

        $("#{{ claim.id }}_new_comment_save").click(function(){
            $.ajax({
                type: 'POST',
                url: "{% url 'comments:add_comment' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    claim_id: '{{ claim.id }}',
                    user_id: '{{ request.user.id }}',
                    title: $("#{{ claim.id }}_new_comment_title").val(),
                    description: $("#{{ claim.id }}_new_comment_description").val(),
                    url: $("#{{ claim.id }}_new_comment_url").val(),
                    label: document.querySelector('input[name="label"]:checked').value,
                },
                success: function () {
                    location.href = 'http://127.0.0.1:8000/claim/{{ claim.id }}';
                },
                error: function (error) {
                    console.log(error);
                    var err = error.responseText;
                    $("#{{ claim.id }}_error_msg").attr("hidden", false);
                    console.log(err.title);
                    location.href = 'http://127.0.0.1:8000/claim/{{ claim.id }}';

                }
            });
        });

        $("#{{ claim.id }}_claim_save").click(function(){
            {#e.preventDefault();#}
            $.ajax({
                type: 'POST',
                url: "{% url 'claims:edit_claim' %}",
                headers: { "X-CSRFToken": getCookie('csrftoken') },
                data: {
                    claim_id: '{{ claim.id }}',
                    claim: $("#{{ claim.id }}_claim").val(),
                    category: $("#{{ claim.id }}_category").val(),
                    tags: $("#{{ claim.id }}_tags").val(),
                    image_src: $("#{{ claim.id }}_image_src").val(),
                    user_id: '{{ request.user.id }}',
                },
                success: function () {
                    location.href = base_url + '/claim/{{ claim.id }}';
                },
                error: function (error) {
                    console.log(error);
                    var err = error.responseText;
                    $("#{{ claim.id }}_error_msg").attr("hidden", false);
                    console.log(err.title);
                    location.href = 'http://127.0.0.1:8000/claim/{{ claim.id }}';

                }
            });
        });

        $("#{{ claim.id }}_claim_delete").click(function(e){
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: "{% url 'claims:delete_claim' %}",
            headers: { "X-CSRFToken": '{{ csrf_token }}' },
            data: {
                claim_id: '{{ claim.id }}',
                user_id: '{{ request.user.id }}'
            },
            success: function () {
                location.href = base_url;
            },
            error: function (error) {
                console.log(error);
            }
        });
    });
    </script>
{% endblock %}




{% block claim_head_title %}
    FactCheckProject | {{ claim }}
{% endblock %}